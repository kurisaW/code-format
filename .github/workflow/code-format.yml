on:
  # å…è®¸åœ¨ GitHub ç•Œé¢ä¸Šæ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œå¹¶å¯ä¼ é€’è¾“å…¥å‚æ•°
  workflow_dispatch:
    inputs:
      exclude-paths:
        description: 'Comma-separated paths to exclude from formatting (e.g., "src/legacy,test/**")'
        required: false
        default: ''
  # å¯é€‰ï¼šå½“æœ‰æ–°çš„ PR æŒ‡å‘é»˜è®¤åˆ†æ”¯æ—¶è§¦å‘ï¼Œæ–¹ä¾¿é€šçŸ¥æˆ–åç»­æ‰‹åŠ¨æ“ä½œ
  pull_request:
    branches: [ main ] # æ›¿æ¢ä¸ºä½ çš„é»˜è®¤åˆ†æ”¯å
    types: [opened, synchronize]

jobs:
  format-code:
    name: Format Code with Astyle
    runs-on: ubuntu-latest
    # ç¡®ä¿è¯¥ä»»åŠ¡ä»…åœ¨ç”± PR è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç ã€‚å…³é”®ï¼šå¯ç”¨ push æƒé™å¹¶è·å–æ‰€æœ‰åˆ†æ”¯å’Œå†å²è®°å½•ã€‚
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }} # æ£€å‡º PR çš„æºå¤´æäº¤
          fetch-depth: 0 # è·å–æ‰€æœ‰ Git å†å²ï¼Œè¿™å¯¹æ­£ç¡® diff å’Œæäº¤å¾ˆé‡è¦

      # æ­¥éª¤ 2: å®‰è£… Astyle
      - name: Setup Astyle
        run: |
          sudo apt-get update
          sudo apt-get install -y astyle

      # æ­¥éª¤ 3: ç¡®å®šéœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆæ’é™¤æŒ‡å®šçš„è·¯å¾„ï¼‰
      - name: Find files to format (excluding specified paths)
        id: find-files
        run: |
          # æ„å»º find å‘½ä»¤çš„æ’é™¤å‚æ•°
          EXCLUDE_CLAUES=""
          if [[ -n "${{ inputs.exclude-paths }}" ]]; then
            IFS=',' read -ra EXCLUDE_PATHS <<< "${{ inputs.exclude-paths }}"
            for path in "${EXCLUDE_PATHS[@]}"; do
              # æ¸…ç†è·¯å¾„ä¸­çš„ç©ºæ ¼ï¼Œå¹¶ä¸ºæ¯ä¸ªæ’é™¤æ¨¡å¼æ·»åŠ  -not -path å‚æ•°
              cleaned_path=$(echo "$path" | xargs)
              EXCLUDE_CLAUES="$EXCLUDE_CLAUES -not -path \"./$cleaned_path\""
            done
          fi

          # ä½¿ç”¨ find å‘½ä»¤æœç´¢ .c å’Œ .cpp æ–‡ä»¶ï¼Œå¹¶åº”ç”¨æ’é™¤è§„åˆ™
          # å°†æ–‡ä»¶åˆ—è¡¨è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²å¹¶å°†å…¶è®¾ç½®ä¸ºè¾“å‡º
          FILE_LIST=$(find . -name "*.c" -o -name "*.cpp" $EXCLUDE_CLAUES | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "files=$FILE_LIST" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 4: è¿è¡Œ Astyle æ ¼å¼åŒ–
      - name: Run Astyle formatting
        run: |
          files_array=$(echo '${{ steps.find-files.outputs.files }}' | jq -r '.[]')
          if [[ -z "$files_array" ]]; then
            echo "No files to format."
            exit 0
          fi

          # ä½¿ç”¨ .astylerc é…ç½®æ–‡ä»¶
          printf '%s\n' $files_array | xargs -I {} astyle \
            --options=".astylerc" \
            {} || true

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ›´æ”¹ï¼Œå¹¶æäº¤
      - name: Check for changes and commit
        id: check-and-commit
        run: |
          # æ£€æŸ¥ Git å·¥ä½œåŒºæ˜¯å¦æœ‰æ›´æ”¹
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes to commit."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changes detected:"
          git diff --name-only

          # é…ç½® Git ç”¨æˆ·
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ›å»ºæäº¤
          git add -A
          git commit -m "style: apply automatic code formatting with astyle"

          # æ¨é€æäº¤å› PR åˆ†æ”¯
          git push

          echo "changes_detected=true" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 6: (å¯é€‰) åœ¨ PR ä¸Šæ·»åŠ è¯„è®ºé€šçŸ¥
      - name: Comment on PR
        if: steps.check-and-commit.outputs.changes_detected == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– Automated code formatting was applied to this PR. Please review the changes.'
            })