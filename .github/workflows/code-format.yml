name: Code Formatting with Astyle

on:
  workflow_dispatch:
    inputs:
      exclude-paths:
        description: 'Comma-separated paths to exclude from formatting (e.g., "src/legacy,test/**")'
        required: false
        default: ''
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  format-code:
    name: Format Code with Astyle
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç  - ä¿®å¤ ref é…ç½®
      - name: Checkout PR head branch
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            BRANCH="${{ github.event.pull_request.head.user.login }}-${BRANCH}"
          fi
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"

      # æ­¥éª¤ 2: å®‰è£… Astyle å’Œ jq
      - name: Setup Astyle and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y astyle jq

      # æ­¥éª¤ 3: ç¡®å®šéœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶åˆ—è¡¨ - ä¿®å¤ inputs é—®é¢˜
      - name: Find files to format (excluding specified paths)
        id: find-files
        run: |
          # æ ¹æ®äº‹ä»¶ç±»å‹è·å–æ’é™¤è·¯å¾„
          EXCLUDE_PATHS_STR=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            EXCLUDE_PATHS_STR="${{ github.event.inputs.exclude-paths }}"
          else
            # å¯¹äº PR äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤å€¼æˆ–ä»å…¶ä»–åœ°æ–¹è·å–
            EXCLUDE_PATHS_STR=""
          fi

          echo "Exclude paths: $EXCLUDE_PATHS_STR"
          
          # æ„å»º find å‘½ä»¤çš„æ’é™¤å‚æ•°
          EXCLUDE_CLAUSES=""
          if [[ -n "$EXCLUDE_PATHS_STR" ]]; then
            IFS=',' read -ra EXCLUDE_PATHS <<< "$EXCLUDE_PATHS_STR"
            for path in "${EXCLUDE_PATHS[@]}"; do
              cleaned_path=$(echo "$path" | xargs)
              if [[ -n "$cleaned_path" ]]; then
                EXCLUDE_CLAUSES="$EXCLUDE_CLAUSES -not -path \"./$cleaned_path\""
              fi
            done
          fi

          echo "Exclude clauses: $EXCLUDE_CLAUSES"
          
          # æŸ¥æ‰¾éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶
          FILE_LIST=$(find . -name "*.c" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" $EXCLUDE_CLAUSES | grep -vE "(/\.git/|/build/|/node_modules/)" || true)
          
          if [[ -z "$FILE_LIST" ]]; then
            echo "No files found to format."
            echo "files=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è½¬æ¢ä¸º JSON æ•°ç»„
          JSON_LIST=$(echo "$FILE_LIST" | jq -R -s -c 'split("\n") | map(select(. != "" and . != "."))')
          echo "files=$JSON_LIST" >> $GITHUB_OUTPUT
          echo "Found $(echo "$FILE_LIST" | wc -l) files to format"

      # æ­¥éª¤ 4: è¿è¡Œ Astyle æ ¼å¼åŒ–
      - name: Run Astyle formatting
        run: |
          files_json='${{ steps.find-files.outputs.files }}'
          if [[ "$files_json" == "[]" ]]; then
            echo "No files to format."
            exit 0
          fi
          
          # è½¬æ¢ä¸ºæ–‡ä»¶æ•°ç»„
          files_array=$(echo '${{ steps.find-files.outputs.files }}' | jq -r '.[]')
          echo "Files to format:"
          echo "$files_array"
          
          if [[ -z "$files_array" ]]; then
            echo "No files to format."
            exit 0
          fi

          # ä½¿ç”¨ .astylerc é…ç½®æ–‡ä»¶æ ¼å¼åŒ–æ¯ä¸ªæ–‡ä»¶
          for file in $files_array; do
            if [[ -f "$file" ]]; then
              echo "Formatting: $file"
              astyle --options=".astylerc" "$file" || true
            fi
          done

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ›´æ”¹ï¼Œå¹¶æäº¤
      - name: Check for changes and commit
        id: check-and-commit
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes to commit."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changes detected:"
          git diff --name-only
          git diff

          # é…ç½® Git ç”¨æˆ·
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # è·å–å½“å‰åˆ†æ”¯å
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ "$BRANCH_NAME" == "$GITHUB_REF" ]]; then
            # å¦‚æœæ˜¯ PRï¼Œä½¿ç”¨ head ref
            BRANCH_NAME=${{ github.head_ref || github.ref_name }}
          fi

          echo "On branch: $BRANCH_NAME"

          # åˆ›å»ºæäº¤
          git add -A
          git commit -m "style: apply automatic code formatting with astyle [skip ci]"

          # æ¨é€æ›´æ”¹
          git push origin HEAD:$BRANCH_NAME

          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes committed and pushed"

      # æ­¥éª¤ 6: åœ¨ PR ä¸Šæ·»åŠ è¯„è®ºé€šçŸ¥
      - name: Comment on PR
        if: steps.check-and-commit.outputs.changes_detected == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– Automated code formatting has been applied to this PR. The changes have been committed to the branch.\n\nPlease review the formatting changes.'
            })
