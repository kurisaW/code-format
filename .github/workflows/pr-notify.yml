name: PR Format Notification
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-format:
    if: github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if first commit in PR
        id: check_first_commit
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // å¦‚æœPRä¸­åªæœ‰1ä¸ªcommitï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€ç¬”æäº¤
            const isFirstCommit = commits.length === 1;
            
            // å¦‚æœæ˜¯synchronizeäº‹ä»¶ï¼ˆæ–°çš„commitæ¨é€ï¼‰ï¼Œä½†commitæ•°å¤§äº1ï¼Œåˆ™ä¸è§¦å‘
            const shouldRun = context.payload.action === 'opened' || 
                             (context.payload.action === 'synchronize' && isFirstCommit);
            
            return shouldRun;

      - name: Create format notification
        if: steps.check_first_commit.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const branch = context.payload.pull_request.head.ref;
            const forkRepo = context.payload.pull_request.head.repo.full_name;
            
            const workflowUrl = `https://github.com/${forkRepo}/actions/workflows/astyle-format.yml`;
            const directLink = `${workflowUrl}?branch=${encodeURIComponent(branch)}`;

            // åˆ›å»ºè¯„è®ºæ¶ˆæ¯
            const message = [
              'ğŸ‘‹ ä½ å¥½ï¼æ„Ÿè°¢ä½ çš„è´¡çŒ®ã€‚ä¸ºäº†ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€ï¼Œè¯·åœ¨ä½ çš„ä»“åº“ä¸­è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥ä½œæµï¼š',
              '',
              'Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:',
              '',
              '**æ­¥éª¤ / Steps:**',
              '1. ğŸ“‹ **å‰å¾€ä½ çš„ä»“åº“ Actions é¡µé¢** / Go to your repository Actions page: [ç‚¹å‡»è¿™é‡Œ](' + directLink + ')',
              '2. âš¡ **è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ** / Run the format workflow: Select "Code Format with Astyle" on the left',
              '3. ğŸš€ **ç‚¹å‡» "Run workflow"** / Click "Run workflow": Use default parameters or adjust as needed',
              '4. â³ **ç­‰å¾…å®Œæˆ** / Wait for completion: The formatted code will be automatically pushed to your branch',
              '',
              '**ç›´è¾¾é“¾æ¥** / Direct link: [è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ / Run Format Workflow](' + directLink + ')',
              '',
              'æ ¼å¼åŒ–å®Œæˆåï¼Œcommit ä¼šè‡ªåŠ¨æ¨é€åˆ°ä½ çš„ `' + branch + '` åˆ†æ”¯ï¼ŒPR ä¼šè‡ªåŠ¨æ›´æ–°ã€‚',
              'After formatting, commits will be automatically pushed to your `' + branch + '` branch and the PR will update automatically.'
            ].join('\n');

            // æ·»åŠ è¯„è®ºåˆ°PR
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: prNumber,
              body: message
            });