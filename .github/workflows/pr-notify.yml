name: PR Format Notification
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-format:
    if: github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    steps:
      - name: Check if first commit and add comment
        run: |
          # è·å–PRçš„commitä¿¡æ¯
          commits=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")
          
          commit_count=$(echo "$commits" | jq '. | length')
          echo "PR commit count: $commit_count"
          
          # åªåœ¨ç¬¬ä¸€ç¬”æäº¤æ—¶è§¦å‘
          if [ "${{ github.event.action }}" = "opened" ] || 
             ([ "${{ github.event.action }}" = "synchronize" ] && [ "$commit_count" -eq 1 ]); then
            
            # æ„å»ºè¯„è®ºæ¶ˆæ¯
            branch="${{ github.event.pull_request.head.ref }}"
            fork_repo="${{ github.event.pull_request.head.repo.full_name }}"
            workflow_url="https://github.com/${fork_repo}/actions/workflows/astyle-format.yml"
            direct_link="${workflow_url}?branch=${branch}"
            
            # ä½¿ç”¨æ•°ç»„æ„å»ºæ¶ˆæ¯
            message_lines=(
              "ğŸ‘‹ ä½ å¥½ï¼æ„Ÿè°¢ä½ çš„è´¡çŒ®ã€‚ä¸ºäº†ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€ï¼Œè¯·åœ¨ä½ çš„ä»“åº“ä¸­è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥ä½œæµï¼š"
              ""
              "Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:"
              ""
              "**æ­¥éª¤ / Steps:**"
              "1. ğŸ“‹ **å‰å¾€ä½ çš„ä»“åº“ Actions é¡µé¢** / Go to your repository Actions page: [ç‚¹å‡»è¿™é‡Œ]($direct_link)"
              "2. âš¡ **è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ** / Run the format workflow: Select \"Code Format with Astyle\" on the left"
              "3. ğŸš€ **ç‚¹å‡» \"Run workflow\"** / Click \"Run workflow\": Use default parameters or adjust as needed"
              "4. â³ **ç­‰å¾…å®Œæˆ** / Wait for completion: The formatted code will be automatically pushed to your branch"
              ""
              "**ç›´è¾¾é“¾æ¥** / Direct link: [è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ / Run Format Workflow]($direct_link)"
              ""
              "æ ¼å¼åŒ–å®Œæˆåï¼Œcommit ä¼šè‡ªåŠ¨æ¨é€åˆ°ä½ çš„ \`$branch\` åˆ†æ”¯ï¼ŒPR ä¼šè‡ªåŠ¨æ›´æ–°ã€‚"
              "After formatting, commits will be automatically pushed to your \`$branch\` branch and the PR will update automatically."
            )
            
            # åˆå¹¶æ•°ç»„ä¸ºå¤šè¡Œå­—ç¬¦ä¸²
            message=$(printf "%s\n" "${message_lines[@]}")
            
            # ä½¿ç”¨GitHub APIæ·»åŠ è¯„è®º
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{\"body\": $(echo "$message" | jq -Rs .)}"
            
            echo "Format notification comment added successfully"
          else
            echo "Not the first commit, skipping comment"
          fi