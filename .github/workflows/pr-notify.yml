name: PR Format Notification
on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  pull-requests: write   # ä»…å…è®¸å†™ PR è¯„è®º
  contents: read         # æœ€å°åŒ–æƒé™

jobs:
  notify-format:
    if: github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    steps:
      - name: Check if first commit and add comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Event action: ${{ github.event.action }}"
          
          commits=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")

          if echo "$commits" | jq -e 'type == "array"' > /dev/null; then
            commit_count=$(echo "$commits" | jq '. | length')
            echo "PR commit count: $commit_count"

            should_comment=false
            if [ "${{ github.event.action }}" = "opened" ]; then
              should_comment=true
            elif [ "${{ github.event.action }}" = "synchronize" ] && [ "$commit_count" -eq 1 ]; then
              should_comment=true
            fi

            if [ "$should_comment" = true ]; then
              echo "Adding format notification comment..."
              
              branch="${{ github.event.pull_request.head.ref }}"
              fork_repo="${{ github.event.pull_request.head.repo.full_name }}"
              workflow_url="https://github.com/${fork_repo}/actions/workflows/astyle-format.yml"
              direct_link="${workflow_url}?branch=${branch}"

              # ä½¿ç”¨æ•°ç»„å­˜å‚¨å¤šè¡Œæ¶ˆæ¯
              message_lines=(
                "ğŸ‘‹ ä½ å¥½ï¼æ„Ÿè°¢ä½ çš„è´¡çŒ®ã€‚ä¸ºäº†ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€ï¼Œè¯·åœ¨ä½ çš„ä»“åº“ä¸­è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥ä½œæµï¼š"
                ""
                "Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:"
                ""
                "**æ­¥éª¤ / Steps:**"
                "1. ğŸ“‹ å‰å¾€ä½ çš„ä»“åº“ Actions é¡µé¢ / Go to your repository Actions page: [ç‚¹å‡»è¿™é‡Œ](${direct_link})"
                "2. âš¡ è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ / Run the format workflow: Select \"Code Format with Astyle\" on the left"
                "3. ğŸš€ ç‚¹å‡» \"Run workflow\" / Click \"Run workflow\": Use default parameters or adjust as needed"
                "4. â³ ç­‰å¾…å®Œæˆ / Wait for completion: The formatted code will be automatically pushed to your branch"
                ""
                "**ç›´è¾¾é“¾æ¥ / Direct link:** [è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ / Run Format Workflow](${direct_link})"
                ""
                "æ ¼å¼åŒ–å®Œæˆåï¼Œcommit ä¼šè‡ªåŠ¨æ¨é€åˆ°ä½ çš„ \`${branch}\` åˆ†æ”¯ï¼ŒPR ä¼šè‡ªåŠ¨æ›´æ–°ã€‚"
                "After formatting, commits will be automatically pushed to your \`${branch}\` branch and the PR will update automatically."
              )

              # æ‹¼æ¥æ•°ç»„ä¸ºå¤šè¡Œå­—ç¬¦ä¸²
              message=$(printf "%s\n" "${message_lines[@]}")

              echo "Message content:"
              echo "$message"

              response=$(curl -s -w "\n%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d "{\"body\": $(echo "$message" | jq -Rs .)}")

              http_code=$(echo "$response" | tail -n1)
              response_body=$(echo "$response" | sed '$d')

              if [ "$http_code" -eq 201 ]; then
                echo "Format notification comment added successfully"
                echo "Comment URL: $(echo "$response_body" | jq -r '.html_url')"
              else
                echo "Failed to add comment. HTTP status: $http_code"
                echo "Response: $response_body"
                exit 1
              fi
            else
              echo "Not the first commit, skipping comment"
            fi
          else
            echo "Failed to get commits from GitHub API"
            echo "Response: $commits"
            exit 1
          fi
