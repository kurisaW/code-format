name: PR Format Notification
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-format:
    if: github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    steps:
      - name: Check if first commit and add comment
        run: |
          # 获取PR的commit信息
          commits=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")
          
          commit_count=$(echo "$commits" | jq '. | length')
          echo "PR commit count: $commit_count"
          
          # 只在第一笔提交时触发
          if [ "${{ github.event.action }}" = "opened" ] || 
             ([ "${{ github.event.action }}" = "synchronize" ] && [ "$commit_count" -eq 1 ]); then
            
            # 构建评论消息
            branch="${{ github.event.pull_request.head.ref }}"
            fork_repo="${{ github.event.pull_request.head.repo.full_name }}"
            workflow_url="https://github.com/${fork_repo}/actions/workflows/astyle-format.yml"
            direct_link="${workflow_url}?branch=${branch}"
            
            # 使用数组构建消息
            message_lines=(
              "👋 你好！感谢你的贡献。为了保持代码风格统一，请在你的仓库中运行代码格式化工作流："
              ""
              "Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:"
              ""
              "**步骤 / Steps:**"
              "1. 📋 **前往你的仓库 Actions 页面** / Go to your repository Actions page: [点击这里]($direct_link)"
              "2. ⚡ **运行格式化工作流** / Run the format workflow: Select \"Code Format with Astyle\" on the left"
              "3. 🚀 **点击 \"Run workflow\"** / Click \"Run workflow\": Use default parameters or adjust as needed"
              "4. ⏳ **等待完成** / Wait for completion: The formatted code will be automatically pushed to your branch"
              ""
              "**直达链接** / Direct link: [运行格式化工作流 / Run Format Workflow]($direct_link)"
              ""
              "格式化完成后，commit 会自动推送到你的 \`$branch\` 分支，PR 会自动更新。"
              "After formatting, commits will be automatically pushed to your \`$branch\` branch and the PR will update automatically."
            )
            
            # 合并数组为多行字符串
            message=$(printf "%s\n" "${message_lines[@]}")
            
            # 使用GitHub API添加评论
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{\"body\": $(echo "$message" | jq -Rs .)}"
            
            echo "Format notification comment added successfully"
          else
            echo "Not the first commit, skipping comment"
          fi