name: PR Format Notification
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-format:
    if: github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if first commit in PR
        id: check_first_commit
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // 如果PR中只有1个commit，说明是第一笔提交
            const isFirstCommit = commits.length === 1;
            
            // 如果是synchronize事件（新的commit推送），但commit数大于1，则不触发
            const shouldRun = context.payload.action === 'opened' || 
                             (context.payload.action === 'synchronize' && isFirstCommit);
            
            return shouldRun;

      - name: Create format notification
        if: steps.check_first_commit.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const branch = context.payload.pull_request.head.ref;
            const forkRepo = context.payload.pull_request.head.repo.full_name;
            
            const workflowUrl = `https://github.com/${forkRepo}/actions/workflows/astyle-format.yml`;
            const directLink = `${workflowUrl}?branch=${encodeURIComponent(branch)}`;

            // 创建评论消息
            const message = [
              '👋 你好！感谢你的贡献。为了保持代码风格统一，请在你的仓库中运行代码格式化工作流：',
              '',
              'Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:',
              '',
              '**步骤 / Steps:**',
              '1. 📋 **前往你的仓库 Actions 页面** / Go to your repository Actions page: [点击这里](' + directLink + ')',
              '2. ⚡ **运行格式化工作流** / Run the format workflow: Select "Code Format with Astyle" on the left',
              '3. 🚀 **点击 "Run workflow"** / Click "Run workflow": Use default parameters or adjust as needed',
              '4. ⏳ **等待完成** / Wait for completion: The formatted code will be automatically pushed to your branch',
              '',
              '**直达链接** / Direct link: [运行格式化工作流 / Run Format Workflow](' + directLink + ')',
              '',
              '格式化完成后，commit 会自动推送到你的 `' + branch + '` 分支，PR 会自动更新。',
              'After formatting, commits will be automatically pushed to your `' + branch + '` branch and the PR will update automatically.'
            ].join('\n');

            // 添加评论到PR
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: prNumber,
              body: message
            });