name: PR Format Notification
on:
  pull_request_target:
    types: [opened, reopened]

jobs:
  notify-format:
    if: |
      github.event.pull_request.head.repo.fork == true &&
      github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Get PR information
        id: pr-info
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          FORK_REPO=${{ github.event.pull_request.head.repo.full_name }}
          BRANCH=${{ github.event.pull_request.head.ref }}
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "fork_repo=$FORK_REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT

      - name: Check for existing notification
        id: check-existing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('Please run the format workflow')
            );
            
            core.setOutput('has_existing', !!existingComment);

      - name: Create format notification
        if: steps.check-existing.outputs.has_existing != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const forkRepo = '${{ steps.pr-info.outputs.fork_repo }}';
            const branch = '${{ steps.pr-info.outputs.branch }}';
            
            const workflowUrl = 'https://github.com/' + forkRepo + '/actions/workflows/astyle-format.yml';
            const actionsUrl = 'https://github.com/' + forkRepo + '/actions';
            const directLink = workflowUrl + '?branch=' + encodeURIComponent(branch);
            
            const message = [
              'ğŸ‘‹ ä½ å¥½ï¼æ„Ÿè°¢ä½ çš„è´¡çŒ®ã€‚ä¸ºäº†ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€ï¼Œè¯·åœ¨ä½ çš„ä»“åº“ä¸­è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥ä½œæµï¼š',
              '',
              'Hello! Thank you for your contribution. To maintain code style consistency, please run the code formatting workflow in your repository:',
              '',
              '**æ­¥éª¤ / Steps:**',
              '1. ğŸ“‹ **å‰å¾€ä½ çš„ä»“åº“ Actions é¡µé¢** / Go to your repository Actions page: [ç‚¹å‡»è¿™é‡Œ](' + actionsUrl + ')',
              '2. âš¡ **è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ** / Run the format workflow: Select "Code Format with Astyle" on the left',
              '3. ğŸš€ **ç‚¹å‡» "Run workflow"** / Click "Run workflow": Use default parameters or adjust as needed',
              '4. â³ **ç­‰å¾…å®Œæˆ** / Wait for completion: The formatted code will be automatically pushed to your branch',
              '',
              '**ç›´è¾¾é“¾æ¥** / Direct link: [è¿è¡Œæ ¼å¼åŒ–å·¥ä½œæµ / Run Format Workflow](' + directLink + ')',
              '',
              'æ ¼å¼åŒ–å®Œæˆåï¼Œcommit ä¼šè‡ªåŠ¨æ¨é€åˆ°ä½ çš„ `' + branch + '` åˆ†æ”¯ï¼ŒPR ä¼šè‡ªåŠ¨æ›´æ–°ã€‚',
              'After formatting, commits will be automatically pushed to your `' + branch + '` branch and the PR will update automatically.'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            console.log('âœ… Format notification comment created');

      - name: Log completion
        run: |
          echo "Format notification process completed"
          echo "PR Number: ${{ steps.pr-info.outputs.pr_number }}"
          echo "Fork Repository: ${{ steps.pr-info.outputs.fork_repo }}"
          echo "Branch: ${{ steps.pr-info.outputs.branch }}"
          echo "Existing notification: ${{ steps.check-existing.outputs.has_existing }}"