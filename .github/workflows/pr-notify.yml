name: PR Format Notification
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  notify-format:
    if: |
      github.event.pull_request.head.repo.fork == true &&
      github.repository == 'kurisaW/code-format'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          gh auth status
          gh api /user

      - name: Parse exclude patterns from comment
        id: parse-exclude
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          
          # 使用GitHub API直接获取评论
          comments=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments")
          
          EXCLUDE_PATTERNS=""
          echo "$comments" | jq -r '.[] | select(.user.login == "github-actions[bot]") | select(.body | contains("⚠️ 本PR来自 fork 仓库")) | .body' | while read -r comment_body; do
            if [[ -n "$comment_body" ]]; then
              if [[ "$comment_body" =~ exclude=([^,]*) ]]; then
                EXCLUDE_PATTERNS="${BASH_REMATCH[1]}"
                break
              fi
            fi
          done
          
          echo "exclude_patterns=$EXCLUDE_PATTERNS" >> $GITHUB_OUTPUT

      - name: Create or update format notification
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          FORK_REPO=${{ github.event.pull_request.head.repo.full_name }}
          BRANCH=${{ github.event.pull_request.head.ref }}
          EXCLUDE=${{ steps.parse-exclude.outputs.exclude_patterns }}
          
          # 构建通知消息
          MESSAGE="⚠️ 本PR来自 fork 仓库（$FORK_REPO），请在你的仓库 Actions 页面点击运行格式化工作流，格式化完成后请将格式化 commit push 到分支 \`$BRANCH\`。"
          MESSAGE="$MESSAGE\n最新格式化流程：[点击跳转](https://github.com/$FORK_REPO/actions/workflows/astyle-format.yml)"
          
          if [ -n "$EXCLUDE" ]; then
            MESSAGE="$MESSAGE\n\n当前排除项：$EXCLUDE"
          fi
          
          MESSAGE="$MESSAGE\n\n如需排除特定文件/目录，请在评论中输入：\n\`/run-astyle-format exclude=dir1,dir2,file1\`"
          
          # 使用GitHub API直接操作评论
          comments_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments")
          
          existing_comment_id=$(echo "$comments_response" | jq -r '.[] | select(.user.login == "github-actions[bot]") | select(.body | contains("⚠️ 本PR来自 fork 仓库")) | .id' | head -1)
          
          if [ -n "$existing_comment_id" ] && [ "$existing_comment_id" != "null" ]; then
            # 更新现有评论
            curl -X PATCH -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$existing_comment_id" \
              -d "{\"body\": \"$MESSAGE\"}"
            echo "Updated existing comment"
          else
            # 创建新评论
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
              -d "{\"body\": \"$MESSAGE\"}"
            echo "Created new comment"
          fi